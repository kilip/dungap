# Development environment override
services:
    api:
        build:
            context: ./api
            target: frankenphp_dev
        volumes:
            - ./api:/app
            - /app/var
            - ./api/frankenphp/Caddyfile:/etc/caddy/Caddyfile:ro
            - ./api/frankenphp/conf.d/app.dev.ini:/usr/local/etc/php/conf.d/app.dev.ini:ro
            - ./docker/supervisor:/etc/supervisor/conf.d
            - /app/vendor
        command:
            - supervisord
            - -c
            - /etc/supervisor/supervisord.conf
            - -n
        environment:
            MERCURE_EXTRA_DIRECTIVES: demo
            # See https://xdebug.org/docs/all_settings#mode
            XDEBUG_MODE: "${XDEBUG_MODE:-off}"
        extra_hosts:
            # Ensure that host.docker.internal is correctly defined on Linux
            - host.docker.internal:host-gateway
        tty: true
        cap_add:
            - NET_ADMIN

    pwa:
        build:
            context: ./pwa
            target: dev
        volumes:
            - ./pwa:/srv/app
            - /srv/app/.next
            - /srv/app/node_modules
            - /srv/app/.pnpm-store
        environment:
            API_PLATFORM_CREATE_CLIENT_ENTRYPOINT: http://api
            API_PLATFORM_CREATE_CLIENT_OUTPUT: .
            # On Linux, you may want to comment the following line for improved performance
            WATCHPACK_POLLING: "true"
            # Development usage only
            NODE_TLS_REJECT_UNAUTHORIZED: "0"